{"version":3,"sources":["../../src/build/android_build.js"],"names":[],"mappings":"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","file":"android_build.js","sourcesContent":["import fs from 'fs';\nimport path from 'path';\n\nimport _ from 'lodash';\nimport moment from 'moment';\nimport shellescape from 'shell-escape';\n\nimport { getFullVersionString } from '../utils/git_utils';\nimport { readPass, generatePass, hasPass } from '../utils/pass_utils';\nimport exec from '../utils/exec';\n\nexport const getAndroidBuildDir = ({ config, environment }) =>\n  path.resolve(`${config.buildDir}/${environment}/android`);\nexport const getAndroidBuildProjectFolder = ({ config, environment }) =>\n  `${getAndroidBuildDir({ config, environment })}/project`;\nexport const getAndroidBuildTool = (config, buildTool) =>\n  path.resolve(\n    `${process.env.ANDROID_HOME}/build-tools/${config.androidBuildToolVersion}/${buildTool}`,\n  );\n\nconst getKeystoreConfig = ({ config, environment }) => {\n  const envConfig = _.get(config, ['environments', environment]);\n  const keyStore = path.resolve(envConfig.androidKeystore);\n  const keystorePWPassPath = `${config.passPath}/android_keystore_pw`;\n  const keyname = envConfig.androidKeyname;\n  const keyDName = envConfig.androidDName;\n  return {\n    keyStore,\n    keyname,\n    keystorePWPassPath,\n    keyDName,\n  };\n};\nconst getKeystoreProps = ({ config, environment }) => {\n  const keyStoreConfig = getKeystoreConfig({ config, environment });\n  const { keystorePWPassPath } = keyStoreConfig;\n  const keystorePW = _.trim(readPass(keystorePWPassPath));\n  return {\n    ...keyStoreConfig,\n    keystorePW,\n  };\n};\n\nexport const androidInit = ({ config, environment }) => {\n  // create keystorePW if not existing\n  const { keystorePWPassPath } = getKeystoreConfig({ config, environment });\n  if (!hasPass(keystorePWPassPath)) {\n    generatePass(keystorePWPassPath);\n  }\n\n  // kudos to http://stackoverflow.com/questions/3997748/how-can-i-create-a-keystore\n  const { keystorePW, keyStore, keyname, keyDName } = getKeystoreProps({ config, environment });\n  const createKeyCommand = shellescape([\n    'keytool',\n    '-genkeypair',\n    '-dname',\n    keyDName,\n    '-alias',\n    keyname,\n    '--storepass',\n    keystorePW,\n    '--keypass',\n    keystorePW,\n    '--keystore',\n    keyStore,\n    '-keyalg',\n    'RSA',\n    '-keysize',\n    2048,\n    '-validity',\n    10000,\n  ]);\n  exec(`echo y | ${createKeyCommand}`, { stdio: 'inherit' });\n};\n\nexport const androidPrepareForStore = ({ config, environment }) => {\n  const { keystorePW, keyStore, keyname } = getKeystoreProps({ config, environment });\n  const androidBuildDir = getAndroidBuildDir({ config, environment });\n  if (!fs.existsSync(androidBuildDir)) {\n    throw new Error('android build dir does not exist');\n  }\n  if (!fs.existsSync(keyStore)) {\n    throw new Error(`please call android-init ${environment} first`);\n  }\n  const now = moment().format('YYYYMMDD-HHmm');\n\n  const inFile = `${androidBuildDir}/project/build/outputs/apk/release/android-release-unsigned.apk`;\n  const alignFile = `${androidBuildDir}/release-unsigned-aligned.apk`;\n  if (fs.existsSync(alignFile)) {\n    fs.unlinkSync(alignFile);\n  }\n  const zipAlignCommand = shellescape([\n    getAndroidBuildTool(config, 'zipalign'),\n    4,\n    inFile,\n    alignFile,\n  ]);\n  exec(zipAlignCommand, { stdio: 'inherit' });\n\n  const outfile = `${androidBuildDir}/${config.appname}-${getFullVersionString(\n    environment,\n  )}-${now}.apk`;\n  if (fs.existsSync(outfile)) {\n    fs.unlinkSync(outfile);\n  }\n  const signCommand = shellescape([\n    getAndroidBuildTool(config, 'apksigner'),\n    'sign',\n    '--ks-key-alias',\n    keyname,\n    '--ks',\n    keyStore,\n    '--ks-pass',\n    'stdin',\n    '--key-pass',\n    'stdin',\n    '--out',\n    outfile,\n    alignFile,\n  ]);\n  exec(signCommand, { input: `${keystorePW}\\n${keystorePW}`, stdio: ['pipe', 1, 2] });\n\n  return outfile;\n};\n"]}